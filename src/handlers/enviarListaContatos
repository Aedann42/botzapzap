// src/handlers/enviarListaContatos.js (VERSÃƒO CHIQUE: LISTA INTERATIVA + TEXTO)

const fs = require('fs');
const path = require('path');
// Importamos a classe List para fazer o "popup chique"
const { List } = require('whatsapp-web.js'); 

// ğŸš¨ CAMINHOS SEGUROS
const ETAPAS_PATH = path.join(process.cwd(), 'data', 'etapas.json');
const CONTATOS_PATH = path.join(process.cwd(), 'data', 'contatos.json');

// --- FUNÃ‡Ã•ES AUXILIARES ---
function carregarEtapas() {
    try {
        if (fs.existsSync(ETAPAS_PATH)) return JSON.parse(fs.readFileSync(ETAPAS_PATH, 'utf8'));
    } catch (e) { console.error('Erro ao ler etapas:', e); }
    return {};
}

function salvarEtapas(etapas) {
    try { fs.writeFileSync(ETAPAS_PATH, JSON.stringify(etapas, null, 2)); } catch (e) {}
}

function carregarContatos() {
    try {
        if (fs.existsSync(CONTATOS_PATH)) return JSON.parse(fs.readFileSync(CONTATOS_PATH, 'utf8'));
    } catch (e) { console.error('Erro ao ler contatos:', e); }
    return [];
}

// --- FUNÃ‡ÃƒO PRINCIPAL ---
async function enviarListaContatos(client, message) {
    const numero = message.from;
    const textoOriginal = message.body.trim(); // Pode vir "1" ou "LogÃ­stica" (se clicar no botÃ£o)
    
    let etapas = carregarEtapas();
    const contatos = carregarContatos();

    if (!contatos || contatos.length === 0) {
        await client.sendMessage(numero, 'âŒ A lista de contatos estÃ¡ vazia.');
        if (etapas[numero]) { delete etapas[numero]; salvarEtapas(etapas); }
        return;
    }

    // =================================================================================
    // ETAPA 1: ENVIAR O MENU (TENTA LISTA INTERATIVA, SE FALHAR, VAI TEXTO)
    // =================================================================================
    if (!etapas[numero] || etapas[numero].etapa !== 'aguardandoEscolha') {
        
        etapas[numero] = { etapa: 'aguardandoEscolha' };
        salvarEtapas(etapas);

        // --- TENTATIVA 1: MODO CHIQUE (LISTA) ---
        try {
            console.log('[enviarListaContatos] Tentando enviar Lista Interativa...');
            
            // Monta as linhas da lista
            const linhasLista = contatos.map((c, index) => ({
                id: (index + 1).toString(), // ID serÃ¡ "1", "2"...
                title: c.setor.substring(0, 24), // TÃ­tulo tem limite de caracteres
                description: c.nome.substring(0, 72) // DescriÃ§Ã£o (Nome da pessoa)
            }));

            const listaInterativa = new List(
                'Selecione o setor desejado para receber o contato:', // Corpo
                'Abrir Contatos', // Texto do BotÃ£o
                [{ title: 'Departamentos', rows: linhasLista }], // SeÃ§Ãµes
                'Lista de Contatos', // TÃ­tulo
                'TarumÃ£ Distribuidora' // RodapÃ©
            );

            await client.sendMessage(numero, listaInterativa);
            return; // Se deu certo, para aqui.

        } catch (erroLista) {
            console.error('[Contatos] Erro ao enviar Lista Interativa (provavelmente nÃ£o suportado). Usando texto.', erroLista.message);
            // Se der erro (comum no Web.js atualmente), o cÃ³digo continua para o texto abaixo
        }

        // --- TENTATIVA 2: MODO TEXTO (FALLBACK) ---
        let resposta = 'ğŸ“‹ *LISTA DE CONTATOS*\nDigite o nÃºmero da opÃ§Ã£o:\n\n';
        contatos.forEach((contato, index) => {
            resposta += `*${index + 1}* - ${contato.setor} (${contato.nome})\n`;
        });
        resposta += '\n_Digite o nÃºmero da opÃ§Ã£o desejada._';

        await client.sendMessage(numero, resposta.trim());
        return;
    }

    // =================================================================================
    // ETAPA 2: PROCESSAR A ESCOLHA (INTELIGENTE)
    // =================================================================================
    if (etapas[numero].etapa === 'aguardandoEscolha') {
        
        let contatoEscolhido = null;

        // Tenta interpretar como NÃšMERO (se digitou "1")
        const possivelIndice = parseInt(textoOriginal.replace(/\D/g, ''));
        
        if (!isNaN(possivelIndice) && possivelIndice > 0 && possivelIndice <= contatos.length) {
            contatoEscolhido = contatos[possivelIndice - 1];
        } 
        // Se nÃ£o for nÃºmero, tenta achar pelo NOME do setor ou pessoa (se clicou no botÃ£o)
        else {
            const textoBusca = textoOriginal.toLowerCase();
            contatoEscolhido = contatos.find(c => 
                c.setor.toLowerCase().includes(textoBusca) || 
                c.nome.toLowerCase().includes(textoBusca)
            );
        }

        // ValidaÃ§Ã£o Final
        if (!contatoEscolhido) {
            await client.sendMessage(numero, 'âŒ NÃ£o entendi sua escolha. Por favor, digite apenas o *nÃºmero* da lista.');
            return; // NÃ£o deleta a etapa, deixa tentar de novo
        }

        // --- SUCESSO: ENVIA O LINK ---
        const apenasNumeros = contatoEscolhido.telefone.replace(/\D/g, '');
        const linkDireto = `https://wa.me/${apenasNumeros}`;

        const msg = `ğŸ“ *Contato Selecionado:*\n\n` +
                    `ğŸ“ *Setor:* ${contatoEscolhido.setor}\n` +
                    `ğŸ‘¤ *Nome:* ${contatoEscolhido.nome}\n` +
                    `ğŸ“± *Telefone:* ${contatoEscolhido.telefone}\n\n` +
                    `ğŸ”— *Clique para conversar:* ${linkDireto}`;

        await client.sendMessage(numero, msg);
        //await client.sendSeen(numero);
        
        delete etapas[numero];
        salvarEtapas(etapas);
    }
}

module.exports = enviarListaContatos;