// src/handlers/enviarListaContatos.js (VERS√ÉO FINAL BLINDADA)

const fs = require('fs');
const path = require('path');

// üö® CORRE√á√ÉO DE CAMINHOS: Garante que l√™ da pasta 'data' na raiz do projeto
// process.cwd() pega o diret√≥rio onde voc√™ roda o comando 'node index.js'
const ETAPAS_PATH = path.join(process.cwd(), 'data', 'etapas.json');
const CONTATOS_PATH = path.join(process.cwd(), 'data', 'contatos.json');

// Fun√ß√µes auxiliares de leitura segura
function carregarEtapas() {
    try {
        if (fs.existsSync(ETAPAS_PATH)) {
            return JSON.parse(fs.readFileSync(ETAPAS_PATH, 'utf8'));
        }
    } catch (e) {
        console.error('Erro ao ler etapas:', e);
    }
    return {};
}

function salvarEtapas(etapas) {
    try {
        fs.writeFileSync(ETAPAS_PATH, JSON.stringify(etapas, null, 2));
    } catch (e) {
        console.error('Erro ao salvar etapas:', e);
    }
}

function carregarContatos() {
    try {
        if (fs.existsSync(CONTATOS_PATH)) {
            return JSON.parse(fs.readFileSync(CONTATOS_PATH, 'utf8'));
        }
    } catch (e) {
        console.error('Erro ao ler contatos:', e);
    }
    return [];
}

// Fun√ß√£o principal
async function enviarListaContatos(client, message) {
    const numero = message.from;
    const textoOriginal = message.body.trim();
    
    let etapas = carregarEtapas();
    const contatos = carregarContatos();

    // Verifica se a lista de contatos existe e tem itens
    if (!contatos || contatos.length === 0) {
        await client.sendMessage(numero, '‚ùå A lista de contatos administrativos est√° vazia no momento.');
        // Se estiver vazio, limpamos a etapa para n√£o travar o usu√°rio
        if (etapas[numero]) {
            delete etapas[numero];
            salvarEtapas(etapas);
        }
        return;
    }

    // --- CEN√ÅRIO 1: USU√ÅRIO AINDA N√ÉO ESCOLHEU (MOSTRAR LISTA) ---
    // Entra aqui se n√£o tiver etapa OU se a etapa n√£o for 'aguardandoEscolha'
    if (!etapas[numero] || etapas[numero].etapa !== 'aguardandoEscolha') {
        
        etapas[numero] = { etapa: 'aguardandoEscolha' };
        salvarEtapas(etapas);

        let resposta = 'üìã *LISTA DE CONTATOS*\nDigite o n√∫mero da op√ß√£o desejada:\n\n';
        contatos.forEach((contato, index) => {
            // Exibe: 1 - Log√≠stica (Jo√£o)
            resposta += `*${index + 1}* - ${contato.setor} (${contato.nome})\n`;
        });
        
        resposta += '\n_Digite apenas o n√∫mero da op√ß√£o para receber o contato._';

        await client.sendMessage(numero, resposta.trim());
        return;
    }

    // --- CEN√ÅRIO 2: USU√ÅRIO ENVIOU A OP√á√ÉO ---
    if (etapas[numero].etapa === 'aguardandoEscolha') {
        
        // Limpa tudo que n√£o for d√≠gito para pegar o n√∫mero da escolha
        const textoLimpo = textoOriginal.replace(/\D/g, '');
        const indice = parseInt(textoLimpo);

        // Se o usu√°rio digitou texto que n√£o √© n√∫mero ou um n√∫mero inv√°lido
        if (isNaN(indice) || indice < 1 || indice > contatos.length) {
            await client.sendMessage(numero, '‚ùå Op√ß√£o inv√°lida. Por favor, digite apenas o *n√∫mero* que aparece na lista acima.');
            return;
        }

        const contatoEscolhido = contatos[indice - 1];

        if (!contatoEscolhido || !contatoEscolhido.telefone) {
            await client.sendMessage(numero, '‚ùå Erro no cadastro deste contato. Avise o administrador.');
            delete etapas[numero];
            salvarEtapas(etapas);
            return;
        }

        // Formata o n√∫mero para link (remove caracteres n√£o num√©ricos)
        // Ex: 553299998888
        const apenasNumeros = contatoEscolhido.telefone.replace(/\D/g, '');
        
        // Cria o link direto (Substitui o vCard que estava quebrando o bot)
        const linkDireto = `https://wa.me/${apenasNumeros}`;

        const msg = `üìû *Contato Selecionado:*\n\n` +
                    `üìç *Setor:* ${contatoEscolhido.setor}\n` +
                    `üë§ *Nome:* ${contatoEscolhido.nome}\n` +
                    `üì± *Telefone:* ${contatoEscolhido.telefone}\n\n` +
                    `üîó *Clique para conversar:* ${linkDireto}`;

        await client.sendMessage(numero, msg);

        // Limpa etapa ap√≥s envio com sucesso
        await client.sendSeen(numero);
        
        delete etapas[numero];
        salvarEtapas(etapas);
    }
}

module.exports = enviarListaContatos;